---
title: "pSIMS Output Managment"
author: "Hamze Dokoohaki"
date: "5/3/2021"
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: true
    highlight: pygments

---

In this tutorial, I will be using `pSIMSSiteMaker` to manage the outputs generated by pSIMS on the cluster.

```{r setup, include=FALSE}
options(warn=-1)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
```



```{r}
library(pSIMSSiteMaker)
library(tidyverse)
```

### Find your simulations on the cluster

In the below example, I use the `remote.execute.cmd` function in the `pSIMSSiteMaker` to execute bash command on the cluster and search for my simulations where they all start with the name `Site ***`. This path `/projects/aces/hamzed/psims/Data/sims` points to where the simulations are running and as it was mentioned `"Site*"`, will ask the cluster to find directories that starts with this name. 


```{r echo=TRUE, eval=FALSE}
host <-
  list(name = 'cc-login.campuscluster.illinois.edu',
       user = 'hamzed',
       tunnel = '~/tunnel/tunnel',
       from=paste0('/home/hamzed/pSIMS/'),
       to='/projects/aces/hamzed/psims/Data')


paths_withruns <- pSIMSSiteMaker::remote.execute.cmd(host,
                                                     'find  /projects/aces/hamzed/psims/Data/sims -type d -name "Site*"')

```

In case your planning to bring back RTM model outputs for different ensembles this script below helps you to monitor your simulations. For each path found from the previous block code in `paths_withruns` we count the number of `csv` files to check if and how many they have finished their run. 

```{r echo=TRUE, eval=FALSE}

Finished_runs <-paths_withruns %>%
  map(~ suppressWarnings({remote.execute.cmd(host, paste0('find ',.x,' -name *.csv | wc -l'))}) %>% as.numeric) %>%
  setNames(paths_withruns) %>%
  discard(~.x==0)

Finished_runs

```

### Zip your simulation results on the cluster

Similar to the above code, this script uses the variable `Finished_runs` (path to the finished runs) to run a command on the cluster in which it create a zip file on each simulation dir with all the model outputs (outputs with the `csv` extension, this could be easily change to bring APSIM outputs by chaning `csv` to `out`). In the below example all the zip files will have their the site name plus `_RTM.zip` as their name. 



```{r echo=TRUE, eval=FALSE}

walk(names(Finished_runs), function(.x){

  tmp_cmd<-paste0('find ',
                  .x,
                  " -type f  -iname '*.csv' | zip ", file.path(.x, basename(.x)),"_RTM.zip -@")

  tmp_file <- tempfile(fileext = ".sh")
  writeLines(tmp_cmd, tmp_file)
  #
  remote.copy.to(host, tmp_file, paste0(.x, "/ziper.sh"))
  remote.execute.cmd(host, paste0(". ", .x,"/ziper.sh"))
})


```


### Bring back the zip files and extract them

Next, when we have created zip files with all the outputs for each simulation, we need to bring back those zip files. The first statement below finds all the zip files in a parent directory including all the simulations (in this case `/projects/aces/hamzed/psims/Data/sims`). Then the `paths_withruns_zip` will have all the paths to the zips files. Next, we use `remote.copy.from` function to bring back the outputs and finally we use the `unzip` function to extract all the csv outputs in their own corresponding dir. 

```{r echo=TRUE, eval=FALSE}

#---- find the zip files and bring them back---------
paths_withruns_zip <- remote.execute.cmd(host, 'find  /projects/aces/hamzed/psims/Data/sims -type f -name "*_RTM.zip"')


#Bring them back
walk(paths_withruns_zip, ~
       remote.copy.from(host=host,
                        src=.x,
                        dst=paste0(getwd(),'/Results/'),
                        delete = TRUE)
)
#------------------------------------------ UNZIP all the outputs
list.files("Results/",".zip", full.names = TRUE)%>%
  walk(~ unzip(.x, junkpaths=TRUE, exdir = file.path("Results/", strsplit(basename(.x),"_")[[1]][2])
  )
  )
```